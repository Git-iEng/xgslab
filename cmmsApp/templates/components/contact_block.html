{% load static %}


<section class="consult-block" {% if form_only %}data-form-only="1" {% endif %}>
    <div class="consult-block__inner">

        {% if not form_only %}
        <!-- Left side (you can replace this content per page) -->
        <aside class="consult-left">
            <span class="consult-badge">Why Choose Us</span>
            <h2 class="consult-title">Trusted by <br>500+ <br>companies</h2>
            <a href="/contact/" class="consult-cta">
                Get Started <span>↗</span>
            </a>
            <figure class="consult-photo">
                <!-- You can replace image; transparent PNG works nicely -->
                <!-- <img src="{% static 'images/cunsult.avif' %}" alt="Consultant" loading="lazy"> -->
            </figure>
        </aside>
        {% endif %}
        <!-- Right side: the form -->
        <div class="consult-form">
            {# Optional: the old server messages will be converted to toasts in JS #}
            {% if messages %}
            {% for m in messages %}
            <div class="consult-alert {{ m.tags }}">{{ m }}</div>
            {% endfor %}
            {% endif %}

            <h3 class="consult-form__title">Send a message</h3>

            <form id="consult-form" class="consult-grid" method="post" action="{% url 'cmmsApp:contact_submit' %}"
                novalidate>
                {% csrf_token %}

                <input type="text" name="name" placeholder="Your Name * " required>
                <input type="email" name="email" placeholder="Your Email Address *" required>

                <input type="text" name="phone" placeholder="Phone Number (e.g. +61 4xx…) *" id="cf_phone" required>

                <select name="country" id="cf_country" class="select-country" required>
                    <option value="" selected disabled>Country *</option>
                    {% if countries %}
                    {% for c in countries %}
                    <option value="{{ c.alpha2 }}" data-dial="{{ c.dial }}">{{ c.name }} ({{ c.dial }})</option>
                    {% endfor %}
                    {% endif %}
                </select>

                <select name="service" aria-label="Select Services" required>
                    <option value="" selected disabled>Select Services *</option>
                    <!-- <option>NEPLAN Electricity</option> -->
                    <option></option>
                    <option>GSA</option>
                    <option>GSA FD</option>
                    <option>XGSA FD</option>
                    <option>XGSA TD</option>
                    <option>NETS</option>
                    <option>SHIELD</option>
                    <option>SHIELD A</option>
                </select>

                <textarea name="message" rows="2" placeholder="Your Message (optional)"></textarea>

                <button id="consult-submit" class="consult-send" type="submit">
                    <span class="label">Send Message</span>
                    <span class="spinner" aria-hidden="true"></span>
                </button>
            </form>
        </div>
    </div>
</section>

<!-- Optional UX sync: derive country from +code or add dial code from country.
   Uses a tiny JSON endpoint provided below. Remove if you prefer only server-side logic.  -->
<!-- Global top-of-page toast -->
<div id="global-toast" class="global-toast" role="status" aria-live="polite"></div>
<script>
(function(){
  const toastEl = document.getElementById('global-toast');

  function showToast(msg, type='error', ms=3800){
    if(!toastEl){
      // As a last resort, fallback to alert()
      alert(msg);
      return;
    }
    toastEl.className = 'global-toast ' + (type === 'success' ? 'global-toast--success'
                                                             : 'global-toast--error');
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    // Make sure user sees it:
    window.scrollTo({ top: 0, behavior: 'smooth' });
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove('show'), ms);
  }

  // Convert any server-side Django messages to a single global toast
  document.querySelectorAll('.consult-alert').forEach(el => {
    const type = el.classList.contains('success') ? 'success' : 'error';
    showToast(el.textContent.trim(), type);
    el.remove();
  });

  // Expose globally if you want to trigger toasts elsewhere:
  window.cmmsToast = showToast;

  /* Keep the rest of your form code (validation, spinner, country/phone sync) */
})();
</script>
<script>
(function(){
  const toastEl = document.getElementById('global-toast');

  function showToast(msg, type='error', ms=3800){
    if(!toastEl){
      // As a last resort, fallback to alert()
      alert(msg);
      return;
    }
    toastEl.className = 'global-toast ' + (type === 'success' ? 'global-toast--success'
                                                             : 'global-toast--error');
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    // Make sure user sees it:
    window.scrollTo({ top: 0, behavior: 'smooth' });
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove('show'), ms);
  }

  // Convert any server-side Django messages to a single global toast
  document.querySelectorAll('.consult-alert').forEach(el => {
    const type = el.classList.contains('success') ? 'success' : 'error';
    showToast(el.textContent.trim(), type);
    el.remove();
  });

  // Expose globally if you want to trigger toasts elsewhere:
  window.cmmsToast = showToast;

  /* Keep the rest of your form code (validation, spinner, country/phone sync) */
})();
</script>


<script>
    (function () {
        const phone = document.getElementById('cf_phone');
        const country = document.getElementById('cf_country');

        // Populate the country list if it has only the placeholder option
        async function ensureCountries() {
            if (!country || country.options.length > 1) return;
            try {
                const r = await fetch("{% url 'cmmsApp:country_list' %}");
                if (!r.ok) return;
                const list = await r.json(); // [{alpha2,name,dial}]
                list.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.alpha2;
                    opt.textContent = `${c.name} (${c.dial})`;
                    opt.dataset.dial = c.dial;
                    country.appendChild(opt);
                });
            } catch (e) { }
        }

        // When country changes, prefill (or update) dial code
        function onCountryChange() {
            const opt = country.options[country.selectedIndex];
            if (!opt || !opt.dataset.dial) return;
            const dial = opt.dataset.dial;
            if (!phone.value || phone.value.trim().charAt(0) !== '+') {
                phone.value = `${dial} `;
            } else {
                // If phone already starts with +, replace just the country code part
                const digits = phone.value.replace(/\s+/g, '');
                const rest = digits.replace(/^\+\d+/, ''); // drop current dial
                phone.value = `${dial}${rest ? ' ' + rest : ' '}`;
            }
        }

        // When phone has +code, look up the country and select it
        async function syncFromPhone() {
            if (!phone || !phone.value.trim()) return;
            try {
                const r = await fetch("{% url 'cmmsApp:phone_info' %}?phone=" +
                    encodeURIComponent(phone.value.trim()));
                if (!r.ok) return;
                const d = await r.json(); // {alpha2,country,e164,dial_code}
                if (d.alpha2) {
                    // select the matching option if it exists
                    const opt = [...country.options].find(o => o.value === d.alpha2);
                    if (opt) country.value = d.alpha2;
                }
                if (d.e164) phone.value = d.e164; // normalized
            } catch (e) { }
        }

        // If user types country name (fallback) – now we always use the select, so skip

        country && country.addEventListener('change', onCountryChange);
        phone && phone.addEventListener('blur', syncFromPhone);

        ensureCountries();
    })();
</script>
<script>
(function(){
  const form    = document.getElementById('consult-form');
  const submit  = document.getElementById('consult-submit');

  function startLoading(){
    submit.classList.add('is-loading');
    submit.disabled = true;                 // only disable the button
    form.classList.add('is-submitting');    // just a visual/UX class
  }
  function stopLoading(){
    submit.classList.remove('is-loading');
    submit.disabled = false;
    form.classList.remove('is-submitting');
  }

  form && form.addEventListener('submit', function(e){
    // keep your validate() call if you have one:
    if (typeof validate === 'function' && !validate()) {
      e.preventDefault();
      return;
    }
    startLoading();  // spinner + prevent double click

    // IMPORTANT: do NOT disable hidden inputs, especially the CSRF token.
    // If you previously had: [...form.elements].forEach(el => el.disabled=true)
    // remove it entirely, or at least skip the token:
    //   const csrf = form.querySelector('input[name=csrfmiddlewaretoken]');
    //   [...form.elements].forEach(el => { if (el !== csrf) el.disabled = true; });
  });

  // (optional) In case you ever submit via AJAX and need the token:
  window.getCsrfToken = () =>
    (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value || '';
})();
</script>

